package:
  name: conda-build-test-always_include_files-glob
  version: 1.0

build:
  number: 0
  always_include_files:
    - lib/libpng*.dylib  # [osx]
    - lib/libpng*.so*     # [linux]
    - Library/lib/libpng*.lib # [win]
  ignore_run_exports:
    - libpng
  script:
    - echo "weee" > $PREFIX/top_level.txt
    - echo "weee" > %PREFIX%\top_level.txt

requirements:
    build:
        - libpng 1.6.17

outputs:
  - name: conda-build-test-always_include_files-glob
  - name: subpackage
    requirements:
      build:
        - jpeg  9.*
    build:
      always_include_files:
        - lib/libjpeg*.dylib   # [osx]
        - lib/libjpeg*.so*     # [linux]
        - Library/lib/libjpeg*.lib # [win]
      ignore_run_exports:
        - jpeg
    script: echo_file.sh
    test:
      commands:
        - test -e $PREFIX/test.txt              # [unix]
        - test -e $PREFIX/lib/libjpeg.9.dylib   # [osx]
        - test -e $PREFIX/lib/libjpeg.dylib   # [osx]
        - test -e $PREFIX/lib/libjpeg.so.9      # [linux]
        - test -e $PREFIX/lib/libjpeg.so      # [linux]
        - if not exist %PREFIX%\Library\lib\libjpeg.lib exit 1   # [win]
        - if not exist %PREFIX%\test.txt exit 1   # [win]

test:
  commands:
    # test that both the always_include_files and the build-created content are present
    - test -e $PREFIX/lib/libpng.dylib  # [osx]
    - test -e $PREFIX/lib/libpng.so  # [linux]
    - if not exist %PREFIX%/bin/libpng.dll exit 1 # [win]
    - test -e $PREFIX/top_level.txt   # [unix]
    - if not exist %PREFIX%\top_level.txt   # [win]
